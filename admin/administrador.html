<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Gesti√≥n de Pedidos ‚Äî Varius</title>
    <link rel="stylesheet" href="assets/css/app.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/payment-modal.css">
    <link rel="stylesheet" href="assets/css/orders.css">
    <link rel="stylesheet" href="../assets/css/presence.css">
    
</head>

<body>
    <input id="nav-toggle" type="checkbox" class="nav-toggle" aria-hidden="true">

    <!-- Top bar -->
    <header class="topbar">
        <div class="top-left">
            <label for="nav-toggle" class="hamburger" aria-hidden="true">
                <span class="hamburger-box"><span class="hamburger-inner"></span></span>
            </label>
            <a class="brand" href="./" aria-label="Dashboard">
                <img src="assets/img/logo.png" alt="Varius" width="14%">
                <span class="brand-text">VARIUS</span>
            </a>
        </div>

        <div class="top-search">
            <!-- input eliminado intencionalmente -->
            <div id="presence-pill" class="presence-pill offline" role="status" aria-live="polite">
                <span class="dot"></span>
                <span class="label">Desconectado</span>
            </div>
        </div>
    </header>

    <div id="app-sidebar"></div>

    <main class="main">
        <!-- KPI cards -->
        <!-- Reemplaza la secci√≥n .kpis por este bloque -->
        <section class="kpis" aria-label="Indicadores r√°pidos">
            <article id="kpi-lowstock" class="card kpi-card kpi-modern kpi-variant-info" role="button" tabindex="0"
                aria-pressed="false">
                <div class="kpi-top">
                    <div class="kpi-avatar" aria-hidden="true">‚ö†Ô∏è</div>
                    <div>
                        <div class="kpi-title">Stock bajo</div>
                        <div class="kpi-sub">Productos con bajo stock</div>
                    </div>
                </div>
                <div class="kpi-divider" role="separator"></div>

                <div>
                    <div class="kpi-amount"><span id="kpi-lowstock-value">3</span></div>
                </div>

                <div class="kpi-bottom">
                    <div class="kpi-meta">Revisar inventario</div>
                    <button class="kpi-action" aria-label="Ver stock">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                            class="bi bi-caret-right-fill" viewBox="0 0 16 16">
                            <path
                                d="m12.14 8.753-5.482 4.796c-.646.566-1.658.106-1.658-.753V3.204a1 1 0 0 1 1.659-.753l5.48 4.796a1 1 0 0 1 0 1.506z" />
                        </svg>
                    </button>
                </div>
            </article>

            <article id="kpi-orders" class="card kpi-card kpi-modern kpi-variant-info" role="button" tabindex="0"
                aria-pressed="false">
                <div class="kpi-top">
                    <div class="kpi-avatar" aria-hidden="true">üì¶</div>
                    <div>
                        <div class="kpi-title">Pedidos hoy</div>
                        <div class="kpi-sub">Comparado con la √∫ltima fecha con pedidos</div>
                    </div>
                </div>
                <div class="kpi-divider"></div>

                <div>
                    <div class="kpi-amount" id="kpi-orders-today">‚Äî</div>
                </div>

                <div class="kpi-bottom">
                    <div class="kpi-meta">√öltima actualizaci√≥n</div>
                    <button class="kpi-action" aria-label="Abrir detalles">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                            class="bi bi-caret-right-fill" viewBox="0 0 16 16">
                            <path
                                d="m12.14 8.753-5.482 4.796c-.646.566-1.658.106-1.658-.753V3.204a1 1 0 0 1 1.659-.753l5.48 4.796a1 1 0 0 1 0 1.506z" />
                        </svg>
                    </button>
                </div>
            </article>

            <article class="card kpi-card kpi-modern kpi-variant-info" aria-hidden="false">
                <div class="kpi-top">
                    <div class="kpi-avatar" aria-hidden="true">üí≤</div>
                    <div>
                        <div class="kpi-title">Ventas</div>
                        <div class="kpi-sub">Total diario (solo pagadas)</div>
                    </div>
                </div>
                <div class="kpi-divider"></div>

                <div>
                    <div class="kpi-amount">$<span id="kpi-sales">‚Äî</span></div>
                </div>

                <div class="kpi-bottom">
                    <div class="kpi-meta">Ingresos verificados</div>
                    <button class="kpi-action" aria-label="Ver ventas">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                            class="bi bi-caret-right-fill" viewBox="0 0 16 16">
                            <path
                                d="m12.14 8.753-5.482 4.796c-.646.566-1.658.106-1.658-.753V3.204a1 1 0 0 1 1.659-.753l5.48 4.796a1 1 0 0 1 0 1.506z" />
                        </svg>
                    </button>
                </div>
            </article>

            <article class="card kpi-card kpi-modern kpi-variant-info" aria-hidden="false">
                <div class="kpi-top">
                    <div class="kpi-avatar" aria-hidden="true">üèß</div>
                    <div>
                        <div class="kpi-title">Caja</div>
                        <div class="kpi-sub">Estado actual</div>
                    </div>
                </div>
                <div class="kpi-divider"></div>

                <div>
                    <div class="kpi-amount">Abierta</div>
                </div>

                <div class="kpi-bottom">
                    <div class="kpi-meta">√ölt. cierre: ‚Äî</div>
                    <button class="kpi-action" aria-label="Acciones caja"
                        onclick="window.location.href='cierre-caja.html'">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                            class="bi bi-caret-right-fill" viewBox="0 0 16 16">
                            <path
                                d="m12.14 8.753-5.482 4.796c-.646.566-1.658.106-1.658-.753V3.204a1 1 0 0 1 1.659-.753l5.48 4.796a1 1 0 0 1 0 1.506z" />
                        </svg>
                    </button>
                </div>
            </article>
        </section>

        <!-- Quick actions (kept) -->
        <section class="table-wrap card quick-actions-card" aria-label="Acciones r√°pidas">
            <div class="table-header" style="padding: 18px 12px;">
                <h3>Acciones R√°pidas</h3>
            </div>
            <div class="quick-actions" style="padding: 12px;">
                <button class="btn btn-view action-primary" data-action="crear-producto"
                    onclick="window.location.href='product.html'">
                    <span class="action-icon">üè¨</span>
                    <span>Ver Productos</span>
                </button>

                <button class="btn btn-view" data-action="gestionar-usuarios"
                    onclick="window.location.href='usuarios.html'">
                    <span class="action-icon">üë•</span>
                    <span>Gestionar Usuarios</span>
                </button>

                <button class="btn btn-view" data-action="cierre-caja"
                    onclick="window.location.href='cierre-caja.html'">
                    <span class="action-icon">üßæ</span>
                    <span>Cierre de caja</span>
                </button>

                <button class="btn btn-view" data-action="CRM" onclick="window.location.href='crm.html'">
                    <span class="action-icon">üñ•Ô∏è</span>
                    <span>CRM</span>
                </button>
            </div>
        </section>
        <!-- Filters -->
        <section class="card filters-card" aria-label="Filtros" style="margin-top: 16px;">
            <div style="display:flex; gap:12px; flex-wrap:wrap; align-items: flex-end;">
                <div class="filter-field" style="min-width:220px;">
                    <label for="filter-status">Estado del Pedido</label>
                    <select id="filter-status">
                        <option value="">Todos</option>
                        <option value="pendiente">Pendiente</option>
                        <option value="asignado">Asignado</option>
                        <option value="en camino">En camino</option>
                        <option value="entregado">Entregado</option>
                        <option value="cancelado">Cancelado</option>
                        <option value="suspendido">Suspendido</option>
                    </select>
                </div>

                <div class="filter-field" style="min-width:220px;">
                    <label for="filter-date">Fecha</label>
                    <input id="filter-date" type="date" />
                </div>

                <div class="filter-field" style="flex:1;min-width:200px;">
                    <label for="filter-client">Buscar cliente</label>
                    <input id="filter-client" type="search" placeholder="Buscar cliente..." />
                </div>

                <div style="display:flex;gap:8px;align-items:end;">
                    <button id="btnFilter" class="btn-apply">Buscar</button>
                    <button id="btnClear" class="icon-btn">Limpiar</button>
                </div>
            </div>
        </section>

        <section class="table-wrap card" style="display:flex;gap:16px;margin-top:16px;">
            <div style="flex:1;min-width:0;">
                <div class="table-header">
                    <h3>Lista de Pedidos</h3>
                </div>

                <div class="table-scroll" id="orders-area">
                    <!-- Desktop / tablet table -->
                    <table id="ordersTable" class="orders-table" aria-label="Tabla de pedidos">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Fecha</th>
                                <th>Total</th>
                                <th>Vendedor</th>
                                <th>Motorizado</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTbody">
                            <!-- Rows injected by JS -->
                        </tbody>
                    </table>

                    <!-- Mobile: cards -->
                    <div id="ordersCards" aria-live="polite"></div>
                </div>
            </div>

            <!-- Chat removed per request -->
        </section>

        <div id="toast" class="toast hidden" role="status" aria-live="polite"></div>
    </main>

    <!-- View Modal -->
    <div id="order-view-modal" class="modal hidden" aria-hidden="true" role="dialog" aria-modal="true">
        <div class="modal-content modal-lg" role="document">
            <div class="modal-header">
                <h2 id="view-order-title">Detalle del Pedido</h2>
                <button class="close-btn" id="view-close" aria-label="Cerrar">&times;</button>
            </div>
            <div class="modal-body" id="view-order-body">
                <!-- Injected -->
            </div>
            <div class="modal-footer"
                style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;">
                <button id="view-history" class="btn-small btn-history" title="Historial del cliente">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-clock-history" viewBox="0 0 16 16">
                        <path
                            d="M8.515 1.019A7 7 0 0 0 8 1V0a8 8 0 0 1 .589.022zm2.004.45a7 7 0 0 0-.985-.299l.219-.976q.576.129 1.126.342zm1.37.71a7 7 0 0 0-.439-.27l.493-.87a8 8 0 0 1 .979.654l-.615.789a7 7 0 0 0-.418-.302zm1.834 1.79a7 7 0 0 0-.653-.796l.724-.69q.406.429.747.91zm.744 1.352a7 7 0 0 0-.214-.468l.893-.45a8 8 0 0 1 .45 1.088l-.95.313a7 7 0 0 0-.179-.483m.53 2.507a7 7 0 0 0-.1-1.025l.985-.17q.1.58.116 1.17zm-.131 1.538q.05-.254.081-.51l.993.123a8 8 0 0 1-.23 1.155l-.964-.267q.069-.247.12-.501m-.952 2.379q.276-.436.486-.908l.914.405q-.24.54-.555 1.038zm-.964 1.205q.183-.183.35-.378l.758.653a8 8 0 0 1-.401.432z" />
                        <path d="M8 1a7 7 0 1 0 4.95 11.95l.707.707A8.001 8.001 0 1 1 8 0z" />
                        <path
                            d="M7.5 3a.5.5 0 0 1 .5.5v5.21l3.248 1.856a.5.5 0 0 1-.496.868l-3.5-2A.5.5 0 0 1 7 9V3.5a.5.5 0 0 1 .5-.5" />
                    </svg>
                </button>
                <button id="view-close-bottom" class="btn-small btn-suspender">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="order-edit-modal" class="modal hidden" aria-hidden="true" role="dialog" aria-modal="true">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2 id="edit-order-title">Editar Pedido</h2>
                <button class="close-btn" id="edit-close" aria-label="Cerrar">&times;</button>
            </div>
            <div class="modal-body" id="edit-order-body">
                <!-- Form -->
                <form id="edit-order-form">
                    <div class="form-row">
                        <label>Cliente</label>
                        <div id="edit-customer" class="small-muted"></div>
                    </div>

                    <div class="form-row inline" style="margin-top:8px;">
                        <div>
                            <label>Motorizado asignado</label>
                            <select id="edit-motorizado">
                                <option value="">-- POR ASIGNAR --</option>
                                <!-- opciones pobladas por JS (usuarios con role == "motorizado") -->
                            </select>
                        </div>
                    </div>

                    <div class="form-row" style="margin-top:8px;">
                        <label>Comentario (obligatorio si cambia motorizado)</label>
                        <textarea id="edit-motorizado-comment" rows="3"
                            placeholder="Justifique el cambio..."></textarea>
                    </div>

                    <hr style="margin:12px 0;" />

                    <div id="edit-items-area">
                        <label>Items</label>
                        <div id="items-list"></div>

                        <!-- Inputs removidos: ahora la adici√≥n se realiza desde la lista de productos disponibles -->
                    </div>

                    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;">
                        <div>
                            <span class="small-muted">Total:</span>
                            <strong id="edit-total">$0.00</strong>
                        </div>
                        <div style="display:flex;gap:8px;">
                            <button id="saveEditBtn" class="btn-apply" type="submit">Guardar</button>
                            <button id="cancelEditBtn" class="btn btn-suspender" type="button">Cancelar</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- LOW STOCK Modal (agregado para kpis.js) -->
    <div id="lowStockModal" class="modal hidden" aria-hidden="true" role="dialog" aria-modal="true">
        <div class="modal-content modal-lg" role="document">
            <div class="modal-header">
                <h2>Productos con stock bajo</h2>
                <button class="close-btn" id="lowStockModalClose" aria-label="Cerrar">&times;</button>
            </div>
            <div class="modal-body" id="lowStockModalBody" style="padding:12px 18px;">
                <div id="lowStockList" style="display:grid;gap:8px;"></div>
            </div>
            <div class="modal-footer" style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px;">
                <button id="lowStockModalOk" class="btn-secondary">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- PAYMENT Modal: modificado para m√∫ltiples m√©todos y conversiones -->
    <div id="paymentModal" class="modal hidden" aria-hidden="true" role="dialog" aria-modal="true"
        aria-labelledby="paymentModalTitle">
        <div class="modal-content" role="document" style="max-width:520px; width:95%; padding:12px 18px;">
            <div class="modal-header">
                <h2 id="paymentModalTitle">Registrar cobranza</h2>
                <button class="close-btn" id="paymentModalClose" aria-label="Cerrar">√ó</button>
            </div>

            <div class="modal-body" id="paymentModalBody" style="padding:12px 0;">
                <div class="card" style="padding:12px; margin-bottom:12px;">
                    <div style="display:flex; justify-content:space-between; gap:12px;">
                        <div>
                            <div style="font-size:13px; color:var(--muted);">Cliente:</div>
                            <div id="pmCustomerName" style="font-weight:600;"></div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:13px; color:var(--muted);">Monto a cobrar (USD):</div>
                            <div id="pmTotal" style="font-weight:700; font-size:16px;">$. 0.00</div>
                            <div id="pmTotalBs" style="font-size:12px; color:var(--muted); margin-top:4px;"></div>
                        </div>
                    </div>
                </div>

                <form id="paymentForm">
                    <!-- M√©todos -->
                    <div class="payment-method" data-method="cash"
                        style="display:flex; align-items:center; gap:12px; padding:10px; border:1px solid var(--border); border-radius:8px; margin-bottom:10px;">
                        <label style="display:flex; gap:8px; align-items:center;">
                            <input type="checkbox" class="pm-check" data-method="cash">
                            <span>Efectivo (Bs.)</span>
                        </label>
                        <input type="text" inputmode="decimal" class="pm-amount" data-method="cash" value="0"
                            style="margin-left:auto; width:140px;" disabled>
                    </div>

                    <div class="payment-method" data-method="usd"
                        style="display:flex; align-items:center; gap:12px; padding:10px; border:1px solid var(--border); border-radius:8px; margin-bottom:10px;">
                        <label style="display:flex; gap:8px; align-items:center;">
                            <input type="checkbox" class="pm-check" data-method="usd">
                            <span>D√≥lares (USD)</span>
                        </label>
                        <input type="text" inputmode="decimal" class="pm-amount" data-method="usd" value="0"
                            style="margin-left:auto; width:140px;" disabled>
                    </div>

                    <div class="payment-method" data-method="mobile"
                        style="display:flex; align-items:center; gap:12px; padding:10px; border:1px solid var(--border); border-radius:8px; margin-bottom:10px;">
                        <label style="display:flex; gap:8px; align-items:center;">
                            <input type="checkbox" class="pm-check" data-method="mobile">
                            <span>Pago M√≥vil (Bs.)</span>
                        </label>
                        <input type="text" inputmode="decimal" class="pm-amount" data-method="mobile" value="0"
                            style="margin-left:auto; width:140px;" disabled>
                    </div>

                    <!-- Mobile bank + reference (hidden until mobile checked) -->
                    <div id="pmMobileDetails" style="display:none; margin-bottom:10px; gap:8px; align-items:center;">
                        <label for="pmMobileBank"
                            style="font-size:13px; color:var(--muted); display:block; margin-bottom:4px;">Banco</label>
                        <select id="pmMobileBank"
                            style="width:100%; padding:8px; border-radius:6px; border:1px solid var(--border); margin-bottom:8px;">
                            <option value="">Selecciona banco</option>
                            <option value="banco_de_venezuela" data-logo="../assets/img/bdv.png">Banco de Venezuela
                            </option>
                            <option value="banesco" data-logo="../assets/img/banesco.png">Banesco</option>
                            <option value="mercantil" data-logo="../assets/img/mercantil.png">Mercantil</option>
                            <option value="provincial" data-logo="../assets/img/provincial.png">Banco Provincial
                            </option>
                            <option value="bicentenario" data-logo="../assets/img/bicentenario.png">Banco Bicentenario
                            </option>
                            <option value="bnc" data-logo="../assets/img/bnc.png">Banco Nacional de Cr√©dito (BNC)
                            </option>
                            <option value="exterior" data-logo="../assets/img/exterior.png">Banco Exterior</option>
                            <option value="bancamiga" data-logo="../assets/img/bancamiga.png">Banca Amiga</option>
                            <option value="others" data-logo="../assets/img/others.png">Otros</option>
                        </select>

                        <label for="pmMobileRef"
                            style="font-size:13px; color:var(--muted); display:block; margin-bottom:4px;">Referencia /
                            N¬∫</label>
                        <input id="pmMobileRef" type="text" placeholder="N√∫mero de referencia"
                            style="width:100%; padding:8px; border-radius:6px; border:1px solid var(--border);">
                    </div>

                    <div class="payment-method" data-method="paypal"
                        style="display:flex; align-items:center; gap:12px; padding:10px; border:1px solid var(--border); border-radius:8px; margin-bottom:10px;">
                        <label style="display:flex; gap:8px; align-items:center;">
                            <input type="checkbox" class="pm-check" data-method="paypal">
                            <span>PayPal (USD)</span>
                        </label>
                        <input type="text" inputmode="decimal" class="pm-amount" data-method="paypal" value="0"
                            style="margin-left:auto; width:140px;" disabled>
                    </div>

                    <div class="payment-method" data-method="other"
                        style="display:flex; align-items:center; gap:12px; padding:10px; border:1px solid var(--border); border-radius:8px; margin-bottom:10px;">
                        <label style="display:flex; gap:8px; align-items:center;">
                            <input type="checkbox" class="pm-check" data-method="other">
                            <span>Otros</span>
                        </label>
                        <input type="text" inputmode="decimal" class="pm-amount" data-method="other" value="0"
                            style="margin-left:auto; width:140px;" disabled>
                    </div>

                    <!-- Conversi√≥n: 3 opciones excluyentes -->
                    <div class="card" style="padding:12px; margin-bottom:10px;">
                        <div style="font-weight:600; margin-bottom:8px;">Conversi√≥n / tasa (para convertir USD ‚Üî Bs)
                        </div>

                        <div style="display:flex; gap:12px; align-items:center; margin-bottom:8px;">
                            <label style="display:flex; gap:8px; align-items:center;">
                                <input type="checkbox" class="pm-conv-check" data-conv="usd_bcv">
                                <span>$ Bs (BCV)</span>
                            </label>

                            <label style="display:flex; gap:8px; align-items:center;">
                                <input type="checkbox" class="pm-conv-check" data-conv="eur_bcv">
                                <span>Euro Bs (BCV)</span>
                            </label>

                            <label style="display:flex; gap:8px; align-items:center;">
                                <input type="checkbox" class="pm-conv-check" data-conv="assign">
                                <span>Asignar</span>
                            </label>
                        </div>

                        <div id="pmAssignRateWrap" style="display:none; margin-top:6px;">
                            <label for="pmAssignRate"
                                style="font-size:13px; color:var(--muted); display:block; margin-bottom:4px;">Tasa
                                personalizada (Bs por
                                USD)</label>
                            <input id="pmAssignRate" type="text" inputmode="decimal" min="0" step="0.01"
                                placeholder="Ej. 12.34" style="width:160px;">
                        </div>

                        <div id="pmConvInfo" style="margin-top:8px; font-size:13px; color:var(--muted);"></div>

                        <div style="margin-top:8px;">
                            <button type="button" id="pmApplyConversion" class="btn-secondary"
                                style="width:100%;">Convertir resto a
                                Pago M√≥vil / Efectivo (Bs)</button>
                        </div>
                    </div>

                    <div class="card" style="padding:12px; margin-top:8px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div style="font-weight:600">Total recibido:</div>
                            <div id="pmReceived" style="font-weight:700">$. 0.00</div>
                        </div>
                        <div
                            style="margin-top:8px; display:flex; justify-content:space-between; gap:8px; align-items:center;">
                            <div>
                                <input type="checkbox" id="pmAmountCorrect" checked>
                                <label for="pmAmountCorrect" style="color:var(--muted); font-size:13px;">Monto
                                    correcto</label>
                            </div>
                            <div id="pmRemaining" style="font-size:13px; color:var(--muted);">Resto: $. 0.00</div>
                        </div>
                        <div id="pmError" style="color:var(--danger); margin-top:8px; display:none;"></div>
                    </div>
                </form>
            </div>

            <div class="modal-footer" style="display:flex; flex-direction:column; gap:8px; padding-top:12px;">
                <button id="pmConfirmBtn" class="btn-primary" style="width:100%;">Confirmar cobranza</button>
                <button id="pmCancelBtn" class="btn-secondary" style="width:100%;">Cancelar</button>
            </div>
        </div>
    </div>


    <script type="module" src="../assets/js/sidebar-loader.js"></script>
    <!-- Admin orders manager -->
    <script type="module" src="../assets/js/bank-select.js"></script>
    <script type="module" src="../assets/js/orders-admin.js"></script>
    <script type="module" src="../assets/js/kpis.js"></script>
    <script type="module" src="../assets/js/presence.js"></script>

</body>

</html>