<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Gesti√≥n de Pedidos ‚Äî Varius</title>
    <link rel="stylesheet" href="assets/css/app.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/presence.css">

    <!-- Estilos adicionales espec√≠ficos para el chat (mejoras: bandeja fija, burbujas, emoji picker, scroll interno, responsive m√≥vil) -->
    <style>
        /* ===== Page-level: disable document scroll, only chat internals scroll ===== */
        html,
        body {
            height: 100%;
        }

        body {
            overflow: hidden;
        }

        .main {
            height: calc(100vh - 64px);
            overflow: hidden;
            box-sizing: border-box;
        }

        #app-sidebar,
        .sidebar {
            height: calc(100vh - 64px);
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* ===== Chat layout and components ===== */
        .chat-layout {
            display: flex;
            height: 100%;
            overflow: hidden;
            gap: 0;
            min-width: 0;
        }

        /* Left column: contact list */
        .chat-list {
            width: 320px;
            min-width: 260px;
            border-right: 1px solid var(--border);
            background: var(--card-bg);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .chat-list .header {
            padding: 18px;
            display: flex;
            gap: 12px;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .chat-list .search {
            padding: 12px 18px;
            border-bottom: 1px solid var(--border);
        }

        .chat-list input[type="search"] {
            width: 100%;
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: #f6f8fa;
        }

        .contacts {
            overflow-y: auto;
            padding: 8px;
            flex: 1;
        }

        .contact-item {
            display: flex;
            gap: 12px;
            align-items: center;
            padding: 12px 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 120ms;
            border-left: 4px solid transparent;
            min-height: 62px;
        }

        .contact-item:hover {
            background: #fbfdff;
        }

        .contact-item.active {
            background: #ecfff3;
            border-left-color: #2dd4bf;
        }

        .contact-item .thumb {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            overflow: hidden;
            flex: 0 0 44px;
        }

        .contact-item .meta {
            flex: 1;
            min-width: 0;
        }

        .contact-item .meta .name {
            font-weight: 700;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            gap: 6px;
            align-items: center;
        }

        .contact-item .meta .last {
            color: var(--muted);
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 4px;
        }

        /* Right column: chat */
        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: transparent;
            min-width: 0;
            height: 100%;
            overflow: hidden;
        }

        .chat-header {
            height: 72px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px;
            border-bottom: 1px solid var(--border);
            background: var(--card-bg);
        }

        /* Back button shown only on small screens when chat is open */
        .back-btn {
            display: none;
            margin-right: 12px;
            padding: 8px 10px;
            border-radius: 10px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 18px;
        }

        /* Messages area: scroll internal */
        .chat-messages {
            flex: 1 1 auto;
            overflow-y: auto;
            padding: 28px 36px;
            position: relative;
            background-image: radial-gradient(#e6eef0 0.9px, transparent 0.9px);
            background-size: 20px 20px;
            padding-bottom: calc(92px + 28px);
            /* espacio para bandeja fija */
        }

        .msg-row {
            display: flex;
            margin-bottom: 18px;
            align-items: flex-end;
            min-width: 0;
        }

        .msg-row.incoming {
            justify-content: flex-start;
        }

        .msg-row.outgoing {
            justify-content: flex-end;
        }

        .msg-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            overflow: hidden;
            flex: 0 0 36px;
            margin-right: 10px;
            box-shadow: 0 1px 0 rgba(11, 15, 34, 0.02);
        }

        .msg-content {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-width: 70%;
            min-width: 0;
            align-items: flex-start;
        }

        .msg-row.outgoing .msg-content {
            align-items: flex-end;
            margin-left: 10px;
            margin-right: 0;
        }

        /* Bubble */
        .bubble {
            position: relative;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 14px;
            box-shadow: 0 6px 18px rgba(11, 15, 34, 0.04);
            line-height: 1.35;
            word-break: break-word;
            display: inline-block;
            max-width: 100%;
        }

        .bubble.incoming {
            background: var(--card-bg);
            border: 1px solid rgba(11, 15, 34, 0.04);
            color: var(--text);
            border-bottom-left-radius: 6px;
            border-bottom-right-radius: 16px;
        }

        .bubble.incoming::after {
            content: "";
            position: absolute;
            left: -6px;
            bottom: 6px;
            width: 10px;
            height: 10px;
            background: var(--card-bg);
            border-left: 1px solid rgba(11, 15, 34, 0.04);
            transform: rotate(45deg);
            z-index: 0;
        }

        .bubble.outgoing {
            background: linear-gradient(180deg, #34d399, #10b981);
            color: white;
            border-bottom-right-radius: 6px;
            border-bottom-left-radius: 16px;
        }

        .bubble.outgoing::after {
            content: "";
            position: absolute;
            right: -6px;
            bottom: 6px;
            width: 10px;
            height: 10px;
            background: linear-gradient(180deg, #34d399, #10b981);
            transform: rotate(45deg);
            z-index: 0;
        }

        .msg-meta {
            display: flex;
            gap: 8px;
            align-items: center;
            font-size: 11px;
            color: var(--muted);
        }

        /* Fixed input tray */
        .chat-input {
            position: sticky;
            bottom: 0;
            z-index: 30;
            background: var(--card-bg);
            border-top: 1px solid var(--border);
            padding: 14px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .input-box {
            width: 100%;
            max-width: 1200px;
            display: flex;
            gap: 10px;
            align-items: center;
            background: #f6fffa;
            border-radius: 18px;
            padding: 10px 12px;
            border: 1px solid #d1f3e8;
            box-shadow: 0 4px 18px rgba(11, 15, 34, 0.03);
        }

        .input-left {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .input-left .icon-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px solid var(--border);
            background: white;
            flex: 0 0 44px;
        }

        .input-box input[type="text"] {
            flex: 1;
            border: none;
            background: transparent;
            padding: 10px;
            outline: none;
            font-size: 14px;
            min-width: 60px;
        }

        .send-btn {
            width: 46px;
            height: 46px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px solid var(--border);
            background: linear-gradient(180deg, #34d399, #10b981);
            color: #fff;
            flex: 0 0 46px;
        }

        /* Emoji picker */
        .emoji-picker {
            position: absolute;
            bottom: 74px;
            left: 20px;
            width: 415px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 12px 36px rgba(11, 15, 34, 0.12);
            overflow: hidden;
            z-index: 60;
        }

        .emoji-header {
            display: flex;
            gap: 6px;
            align-items: center;
            background: #f8fafc;
            padding: 8px;
            border-bottom: 1px solid var(--border);
        }

        .emoji-cat-btn {
            padding: 8px 10px;
            border-radius: 8px;
            cursor: pointer;
            background: transparent;
            border: none;
            font-size: 14px;
            color: var(--muted);
        }

        .emoji-cat-btn.active {
            background: #eefaf6;
            color: #059669;
            box-shadow: inset 0 0 0 1px rgba(5, 150, 105, 0.06);
            font-weight: 700;
        }

        .emoji-grid {
            padding: 12px;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            max-height: 240px;
            overflow: auto;
        }

        .emoji-grid button {
            font-size: 20px;
            padding: 6px;
            border-radius: 8px;
            background: transparent;
            border: none;
            cursor: pointer;
        }

        .emoji-grid button:hover {
            background: #f3f4f6;
        }

        @keyframes blink {
            0% {
                opacity: 0.2
            }

            50% {
                opacity: 1
            }

            100% {
                opacity: 0.2
            }
        }

        /* scrollbars */
        .contacts::-webkit-scrollbar,
        .chat-messages::-webkit-scrollbar,
        .emoji-grid::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .contacts::-webkit-scrollbar-thumb,
        .chat-messages::-webkit-scrollbar-thumb,
        .emoji-grid::-webkit-scrollbar-thumb {
            background: #e6e8eb;
            border-radius: 8px;
        }

        /* ===== Mobile responsiveness: show inbox first, tap to open chat, back to inbox =====
       Strategy:
       - On small screens hide chat-panel by default (show list)
       - When user opens a chat we add .show-chat to .chat-layout to show panel full-screen and hide list
       - Back button in header to return to list
    */
        @media (max-width: 900px) {
            .chat-list {
                width: 100%;
                min-width: 0;
                border-right: none;
            }

            .chat-panel {
                display: none;
                width: 100%;
                position: relative;
            }

            .emoji-picker {
                left: 12px;
                width: 280px;
            }

            .bubble {
                font-size: 13px;
            }

            /* When .chat-layout.show-chat is set, hide the list and show panel */
            .chat-layout.show-chat .chat-list {
                display: none;
            }

            .chat-layout.show-chat .chat-panel {
                display: flex;
            }

            /* Show back button */
            .back-btn {
                display: inline-flex;
                align-items: center;
                gap: 8px;
            }

            .chat-header {
                padding-left: 12px;
                padding-right: 12px;
            }

            /* Ensure input tray is easily reachable */
            .chat-input {
                padding-left: 12px;
                padding-right: 12px;
            }
        }

        /* Tiny screens adjustments */
        @media (max-width: 420px) {
            .emoji-grid {
                grid-template-columns: repeat(6, 1fr);
            }

            .chat-messages {
                padding-left: 18px;
                padding-right: 18px;
            }

            .input-box {
                padding-left: 8px;
                padding-right: 8px;
                border-radius: 14px;
            }
        }
    </style>
</head>

<body>
    <input id="nav-toggle" type="checkbox" class="nav-toggle" aria-hidden="true">

    <!-- Top bar -->
    <header class="topbar">
        <div class="top-left">
            <label for="nav-toggle" class="hamburger" aria-hidden="true">
                <span class="hamburger-box"><span class="hamburger-inner"></span></span>
            </label>
            <a class="brand" href="./" aria-label="Dashboard">
                <img src="assets/img/logo.png" alt="Varius" width="14%">
                <span class="brand-text">VARIUS</span>
            </a>
        </div>

        <div class="top-search">
            <div id="presence-pill" class="presence-pill offline" role="status" aria-live="polite">
                <span class="dot"></span>
                <span class="label">Desconectado</span>
            </div>
        </div>
    </header>

    <div id="app-sidebar"></div>

    <main class="main">
        <!-- Chat layout integrated -->
        <section id="chat-layout" class="chat-layout" role="region" aria-label="Chat de clientes">
            <!-- Left: list of chats -->
            <aside class="chat-list" aria-label="Lista de conversaciones">
                <div class="header">
                    <div class="thumb"
                        style="width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,#34d399,#10b981); display:flex;align-items:center;justify-content:center;color:white;font-weight:700">
                        V</div>
                    <div>
                        <h3 style="margin:0;font-size:16px">Chats</h3>
                        <div style="font-size:12px;color:var(--muted)">Atiende a tus clientes</div>
                    </div>
                </div>

                <div class="search">
                    <input id="contact-search" type="search" placeholder="Buscar conversaci√≥n..."
                        aria-label="Buscar conversaci√≥n">
                </div>

                <div id="contact-list" class="contacts" role="list" aria-label="Contactos">
                    <!-- se inyecta por JS -->
                </div>
            </aside>

            <!-- Right: chat panel -->
            <section class="chat-panel" aria-live="polite">
                <div id="chat-header" class="chat-header" aria-hidden="false">
                    <!-- header content injected by JS; includes back button for mobile -->
                </div>

                <div id="messages-container" class="chat-messages" role="log" aria-live="polite" aria-atomic="false">
                    <!-- mensajes inyectados por JS -->
                </div>

                <!-- Emoji picker (absolute, toggled) -->
                <div id="emoji-picker" class="emoji-picker" hidden>
                    <div class="emoji-header" role="tablist" aria-label="Categor√≠as de emojis" id="emoji-categories">
                    </div>
                    <div class="emoji-grid" id="emoji-grid" role="grid" aria-label="Emojis"></div>
                </div>

                <div class="chat-input" aria-label="√Årea de env√≠o">
                    <div class="input-box" role="form" aria-label="Enviar mensaje">
                        <div class="input-left">
                            <button id="emoji-btn" class="icon-btn" aria-haspopup="true" aria-expanded="false"
                                title="Emojis">üòä</button>
                        </div>
                        <input id="chat-input" type="text" placeholder="Escribe un mensaje..."
                            aria-label="Escribe un mensaje">
                        <button id="send-btn" class="send-btn" title="Enviar">üöÄ</button>
                    </div>
                </div>
            </section>
        </section>

        <div id="toast" class="toast hidden" role="status" aria-live="polite"></div>
    </main>

    <script type="module">
        // ===== Data & DOM =====
        const MOCK_CONTACTS = [
            { id: '1', name: 'Ana Mart√≠nez', avatar: 'https://picsum.photos/seed/ana/100/100', status: 'online', unread: 1, lastMsg: '¬øLlegar√° hoy el pedido?' },
            { id: '2', name: 'Carlos Morales', avatar: 'https://picsum.photos/seed/carlos/100/100', status: 'offline', unread: 0, lastMsg: 'Perfecto, muchas gracias' },
            { id: '3', name: 'Laura Garc√≠a', avatar: 'https://picsum.photos/seed/laura/100/100', status: 'online', unread: 2, lastMsg: '¬øTienen disponibilidad?' },
            { id: '4', name: 'Juan Silva', avatar: 'https://picsum.photos/seed/juan/100/100', status: 'online', unread: 0, lastMsg: 'Excelente servicio.' },
        ];

        const EMOJI_DATA = [
            { category: 'Smileys', icon: 'üòä', emojis: ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá', 'üôÇ', 'üòâ', 'üòç', 'ü•∞', 'üòò', 'üòã', 'üòõ', 'üòú', 'üòé', 'ü•≥', 'ü§î', 'ü§≠', 'ü§´', 'üò¥', 'üòµ', 'ü§¢', 'ü§Æ', 'ü§ß', 'ü§†', 'ü§°'] },
            { category: 'Corazones', icon: '‚ù§Ô∏è', emojis: ['‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò'] },
            { category: 'Comida', icon: 'üçï', emojis: ['üçè', 'üçé', 'üçê', 'üçä', 'üçã', 'üçå', 'üçâ', 'üçá', 'üçì', 'üçí', 'üçë', 'ü•≠', 'üçç', 'ü••', 'ü•ù', 'üçÖ', 'üçÜ', 'ü•ë', 'ü•¶', 'üåΩ', 'ü•ï', 'ü•î', 'ü•ê', 'üçû', 'üßÄ', 'üç≥'] },
            { category: 'Objetos', icon: 'üí°', emojis: ['‚åöÔ∏è', 'üì±', 'üíª', 'üì∑', 'üì∫', '‚è∞', 'üîã', 'üîå', 'üí°', 'üí∏', 'üí∞', 'üí≥', 'üíé', 'üõ†', 'üîí', 'üîë', 'üß≠', 'üßø', 'üî¨', 'üî≠'] }
        ];

        let activeContactId = MOCK_CONTACTS[0].id;
        let messages = {}; // { contactId: [{text,isMe,time}] }

        const chatLayoutEl = document.getElementById('chat-layout');
        const contactListEl = document.getElementById('contact-list');
        const chatHeaderEl = document.getElementById('chat-header');
        const messagesContainerEl = document.getElementById('messages-container');
        const chatInputEl = document.getElementById('chat-input');
        const sendBtnEl = document.getElementById('send-btn');
        const emojiBtnEl = document.getElementById('emoji-btn');
        const contactSearchEl = document.getElementById('contact-search');
        const emojiPickerEl = document.getElementById('emoji-picker');
        const emojiCategoriesEl = document.getElementById('emoji-categories');
        const emojiGridEl = document.getElementById('emoji-grid');

        // ===== Rendering =====
        function renderContactList(filter = '') {
            const q = filter.trim().toLowerCase();
            contactListEl.innerHTML = MOCK_CONTACTS
                .filter(c => !q || c.name.toLowerCase().includes(q) || (c.lastMsg || '').toLowerCase().includes(q))
                .map(contact => {
                    const active = activeContactId === contact.id ? 'active' : '';
                    return `
            <div role="listitem" tabindex="0" class="contact-item ${active}" data-id="${contact.id}">
              <div class="thumb"><img src="${contact.avatar}" alt="${contact.name}" style="width:44px;height:44px;object-fit:cover;border-radius:50%"></div>
              <div class="meta">
                <div class="name">${contact.name} ${contact.unread ? `<span style="background:#10b981;color:white;border-radius:12px;padding:2px 8px;font-size:12px">${contact.unread}</span>` : ''}</div>
                <div class="last">${contact.lastMsg || ''}</div>
              </div>
            </div>
          `;
                }).join('');

            contactListEl.querySelectorAll('.contact-item').forEach(el => {
                el.addEventListener('click', () => onContactClick(el.dataset.id));
                el.addEventListener('keydown', (e) => { if (e.key === 'Enter') onContactClick(el.dataset.id); });
            });
        }

        // Handle contact click with mobile behavior
        function onContactClick(id) {
            setActiveContact(id);
            // If on narrow screen show only chat panel
            if (window.matchMedia && window.matchMedia('(max-width: 900px)').matches) {
                chatLayoutEl.classList.add('show-chat');
            }
        }

        function renderChatHeader() {
            const contact = MOCK_CONTACTS.find(c => c.id === activeContactId) || {};
            const isMobile = window.matchMedia && window.matchMedia('(max-width: 900px)').matches;
            chatHeaderEl.innerHTML = `
        <div style="display:flex;gap:12px;align-items:center">
          ${isMobile ? `<button id="back-to-list" class="back-btn" aria-label="Volver a bandeja">‚¨Ö</button>` : ''}
          <div style="width:44px;height:44px;border-radius:50%;overflow:hidden"><img src="${contact.avatar || ''}" alt="${contact.name || ''}" style="width:100%;height:100%;object-fit:cover"></div>
          <div>
            <div style="font-weight:700">${contact.name || ''}</div>
            <div style="font-size:12px;color:${contact.status === 'online' ? '#10b981' : 'var(--muted)'}">${contact.status === 'online' ? 'En l√≠nea' : 'Desconectado'}</div>
          </div>
        </div>
        <div>
          <div style="display:inline-flex;align-items:center;gap:8px;background:#e6fff3;color:#065f46;padding:6px 10px;border-radius:20px;font-weight:700;font-size:12px">‚óè ACTIVO</div>
        </div>
      `;

            // Back button handler (only exists on mobile)
            const backBtn = document.getElementById('back-to-list');
            if (backBtn) {
                backBtn.addEventListener('click', () => {
                    chatLayoutEl.classList.remove('show-chat');
                });
            }
        }

        function renderMessages() {
            const chatMsgs = messages[activeContactId] || [{ text: '¬°Hola! Bienvenido al soporte de Varius.', isMe: false, time: '09:00' }];
            messages[activeContactId] = chatMsgs;

            messagesContainerEl.innerHTML = chatMsgs.map(msg => {
                const sideClass = msg.isMe ? 'outgoing' : 'incoming';
                return `
          <div class="msg-row ${sideClass}">
            ${!msg.isMe ? `<div class="msg-avatar"><img src="${getContactAvatar(activeContactId)}" alt="" style="width:100%;height:100%;object-fit:cover"></div>` : ''}
            <div class="msg-content">
              <div class="bubble ${msg.isMe ? 'outgoing' : 'incoming'}">${escapeHtml(msg.text)}</div>
              <div class="msg-meta">${msg.time}</div>
            </div>
          </div>
        `;
            }).join('');

            // scroll to bottom
            messagesContainerEl.scrollTop = messagesContainerEl.scrollHeight;
        }

        function getContactAvatar(id) {
            const c = MOCK_CONTACTS.find(x => x.id === id);
            return c ? c.avatar : 'https://picsum.photos/seed/default/100/100';
        }

        // ===== Helpers =====
        function nowTime() {
            return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function escapeHtml(text) {
            return String(text).replace(/[&<>"']/g, (m) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
        }

        // ===== Actions =====
        function setActiveContact(id) {
            activeContactId = id;
            const contact = MOCK_CONTACTS.find(c => c.id === id);
            if (contact) contact.unread = 0;
            renderContactList(contactSearchEl.value || '');
            renderChatHeader();
            renderMessages();
            chatInputEl.focus();
        }

        async function handleSendMessage() {
            const text = chatInputEl.value.trim();
            if (!text) return;
            const time = nowTime();
            const msg = { text, isMe: true, time };
            messages[activeContactId] = messages[activeContactId] || [];
            messages[activeContactId].push(msg);

            const contact = MOCK_CONTACTS.find(c => c.id === activeContactId);
            if (contact) contact.lastMsg = text;

            chatInputEl.value = '';
            renderMessages();
            renderContactList();

            // Simulated reply (replace with your backend or websocket)
            simulateAutoReply(contact, text);
        }

        function simulateAutoReply(contact, userText) {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'msg-row incoming';
            typingDiv.innerHTML = `
        <div class="msg-avatar"><div style="width:36px;height:36px;border-radius:50%;background:#f3f4f6"></div></div>
        <div class="msg-content">
          <div class="bubble incoming" style="display:flex;gap:6px;align-items:center">
            <span style="width:8px;height:8px;background:#cbd5e1;border-radius:50%;display:inline-block;animation:blink 1s infinite"></span>
            <span style="width:8px;height:8px;background:#cbd5e1;border-radius:50%;display:inline-block;animation:blink 1s infinite .2s"></span>
            <span style="width:8px;height:8px;background:#cbd5e1;border-radius:50%;display:inline-block;animation:blink 1s infinite .4s"></span>
          </div>
        </div>
      `;
            messagesContainerEl.appendChild(typingDiv);
            messagesContainerEl.scrollTop = messagesContainerEl.scrollHeight;

            setTimeout(() => {
                typingDiv.remove();
                const reply = { text: generateReply(userText), isMe: false, time: nowTime() };
                messages[activeContactId].push(reply);
                if (contact) contact.lastMsg = reply.text;
                renderMessages();
                renderContactList();
            }, 900 + Math.random() * 900);
        }

        function generateReply(userText) {
            if (/pedido|llegad/i.test(userText)) return 'Estamos procesando tu pedido, te aviso cuando salga.';
            if (/gracias|perfecto|ok/i.test(userText)) return 'Perfecto, quedo atento.';
            if (userText.length < 3) return '¬øPodr√≠as ampliar un poco tu mensaje?';
            return 'Gracias por escribirnos. En breve un agente lo atender√°.';
        }

        // ===== Emoji picker =====
        function renderEmojiPicker() {
            emojiCategoriesEl.innerHTML = EMOJI_DATA.map((cat, idx) => `
        <button role="tab" aria-selected="${idx === 0}" class="emoji-cat-btn ${idx === 0 ? 'active' : ''}" data-idx="${idx}">${cat.icon} ${cat.category}</button>
      `).join('');
            setEmojiCategory(0);
            emojiCategoriesEl.querySelectorAll('.emoji-cat-btn').forEach(btn => {
                btn.addEventListener('click', () => setEmojiCategory(parseInt(btn.dataset.idx, 10)));
            });
        }

        function setEmojiCategory(idx) {
            emojiCategoriesEl.querySelectorAll('.emoji-cat-btn').forEach((b, i) => {
                b.classList.toggle('active', i === idx);
                b.setAttribute('aria-selected', i === idx ? 'true' : 'false');
            });
            const cat = EMOJI_DATA[idx];
            emojiGridEl.innerHTML = cat.emojis.map(e => `<button type="button" class="emoji-cell" data-emoji="${e}">${e}</button>`).join('');
            emojiGridEl.querySelectorAll('.emoji-cell').forEach(btn => {
                btn.addEventListener('click', () => insertEmoji(btn.dataset.emoji));
            });
        }

        function insertEmoji(emoji) {
            const input = chatInputEl;
            const start = input.selectionStart || input.value.length;
            const end = input.selectionEnd || start;
            const text = input.value;
            input.value = text.slice(0, start) + emoji + text.slice(end);
            const newPos = start + emoji.length;
            input.setSelectionRange(newPos, newPos);
            input.focus();
        }

        function toggleEmojiPicker(force) {
            const isHidden = emojiPickerEl.hasAttribute('hidden');
            const show = (typeof force === 'boolean') ? force : isHidden;

            if (show) {
                // Asegurar que chat-panel est√© posicionado (por si no se aplic√≥ el CSS por alguna raz√≥n)
                const panel = document.querySelector('.chat-panel');
                if (panel) panel.style.position = panel.style.position || 'relative';

                // Dimensiones del bot√≥n y del panel para calcular left relativo
                const btnRect = emojiBtnEl.getBoundingClientRect();
                const panelRect = panel.getBoundingClientRect();

                // Ajusta el ancho del picker si el panel es m√°s peque√±o
                const pickerMaxWidth = 320;
                const pickerWidth = Math.min(pickerMaxWidth, Math.max(200, panelRect.width - 24));
                emojiPickerEl.style.width = `${pickerWidth}px`;

                // calcular left relativo al panel (btn.left - panel.left) y centrar el picker respecto al bot√≥n
                let left = (btnRect.left - panelRect.left) + (btnRect.width / 2) - (pickerWidth / 2);

                // limitar para que no se salga del panel (8px padding de seguridad)
                left = Math.max(8, Math.min(left, panelRect.width - pickerWidth - 8));

                emojiPickerEl.style.left = `${left}px`;

                // Mantener bottom por CSS (por encima de la bandeja), pero puedes calcularlo din√°micamente si lo prefieres.
                emojiPickerEl.removeAttribute('hidden');
                emojiBtnEl.setAttribute('aria-expanded', 'true');
            } else {
                emojiPickerEl.setAttribute('hidden', '');
                emojiBtnEl.setAttribute('aria-expanded', 'false');
                // limpiar estilos inline si prefieres
                // emojiPickerEl.style.left = '';
                // emojiPickerEl.style.width = '';
            }
        }

        // close picker when click outside
        document.addEventListener('click', (e) => {
            if (!emojiPickerEl.contains(e.target) && e.target !== emojiBtnEl) {
                toggleEmojiPicker(false);
            }
        });

        emojiBtnEl.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleEmojiPicker();
        });

        // ===== Listeners & init =====
        contactSearchEl.addEventListener('input', (e) => renderContactList(e.target.value));
        sendBtnEl.addEventListener('click', handleSendMessage);
        chatInputEl.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSendMessage(); });

        // Re-render header when resizing to show/hide back button appropriately
        window.addEventListener('resize', () => {
            renderChatHeader();
            // if mobile and currently showing chat but width increased >900, ensure both panels visible
            if (!window.matchMedia('(max-width:900px)').matches) {
                chatLayoutEl.classList.remove('show-chat');
            }
        });

        renderContactList();
        renderChatHeader();
        renderMessages();
        renderEmojiPicker();

        // Accessibility: open emoji with Alt+E
        document.addEventListener('keydown', (e) => {
            if ((e.altKey || e.metaKey) && e.key.toLowerCase() === 'e') {
                e.preventDefault();
                toggleEmojiPicker(true);
            }
        });

        // ===== Real-time integration hints (optional) =====
        // To enable "real time" replace simulateAutoReply with a WebSocket or SSE connection.
        // Example skeleton:
        // const ws = new WebSocket('wss://tu-servidor/ws');
        // ws.onopen = () => console.log('ws open');
        // ws.onmessage = (ev) => {
        //   const data = JSON.parse(ev.data);
        //   // data: { fromId, text, time }
        //   messages[data.fromId] = messages[data.fromId] || [];
        //   messages[data.fromId].push({ text: data.text, isMe: false, time: data.time || nowTime() });
        //   // if message is for current contact, renderMessages(); else mark unread and update list
        //   if (data.fromId === activeContactId) {
        //     renderMessages();
        //   } else {
        //     const c = MOCK_CONTACTS.find(x => x.id === data.fromId);
        //     if (c) { c.unread = (c.unread || 0) + 1; c.lastMsg = data.text; }
        //     renderContactList(contactSearchEl.value || '');
        //   }
        // };

    </script>

    <script type="module" src="../assets/js/sidebar-loader.js"></script>
</body>

</html>